# Run build-grammar.ts to convert this yaml file.
# See https://macromates.com/manual/en/language_grammars section 12.4 naming conventions.

name: Overwatch Script To Workshop
scopeName: source.del
fileTypes: [del, ostw, workshop]
$schema: https://raw.githubusercontent.com/Septh/tmlanguage/master/tmLanguage.schema.json

variables:
  part: '([_[:alnum:]]+)'
  # (?<set-type> - Names the entire type group, which is used for recursion later.
  #   {{part}}\b\s* - The name of the type. \b is used for the end of the word, \s* is for any number of spaces that may proceed the type name.
  #   - type arguments
  #   (\s* - Start of type arguments group. Start with any amount of whitespace.
  #     ,?\s* - This group can be repeated, check for a comma.
  #     \g<set-type>
  #     \s*
  #   )?\s*
  #   - end type arguments
  #   (\[\s*\])* - Array markers '[]'
  # )
  type: '(?<set-type>{{part}}\b\s*(<\s*(\s*,?\s*\g<set-type>\s*)*>)?\s*(\[\s*\])*)' # 5 groups
  # define a =
  declare-variable-start: '{{type}}\s*{{part}}\s*(=)?'
  string-double: \"(?:[^"\\]|\\.)*\"
  string-single: \'(?:[^'\\]|\\.)*\'
  encapsulated-block-end: '(?<=})|(?<=;)'
  attribute-list: ((public|private|protected|virtual|override|abstract|static)\s+)*

  # Scopes
  statement-end: punctuation.terminator.statement.ostw
  assignment: keyword.operator.assignment.ostw
  define: keyword.other
  
patterns:
- include: '#rule-set'

repository:
  # The root of a default OSTW script.
  rule-set:
    patterns:
    - include: '#rule'
    - include: '#declare-function'
    - include: '#declare-variable'
  
  # Applies syntax highlighting to an already matched type.
  type-matcher:
    patterns:
      # 'define' default type.
      - match: 'define'
        name: '{{define}}'
      # other types
      - match: '{{part}}'
        name: entity.name.type
      # Array
      - match: '\['
        name: punctuation.squarebracket.open
      - match: '\]'
        name: punctuation.squarebracket.close
      # Generics
      - match: '<'
        name: punctuation.definition.typeparameters.begin
      - match: '>'
        name: punctuation.definition.typeparameters.end
      # Generics seperator
      - match: ','
        name: punctuation.separator.comma
  
  # Variable definition syntax
  declare-variable:
    begin: '{{declare-variable-start}}(?!\s*\()'
    end: ;
    patterns:
      - include: '#expression'
    beginCaptures:
      # Apply highlighting to the type match
      1:
        patterns:
          - include: '#type-matcher'
      6: # The variable name
        name: variable
      7: # The equals for an initial value.
        name: '{{assignment}}'
    endCaptures:
      0:
        name: '{{statement-end}}'
  
  # Function and macro declaration
  declare-function:
    begin: '{{attribute-list}}{{type}}\s*{{part}}\s*(?=\(|:)'
    end: '{{encapsulated-block-end}}'
    beginCaptures:
      2:
        name: storage.modifier
      3:
        patterns:
          - include: '#type-matcher'
      8:
        name: entity.name.function
    patterns:
      - include: '#parameter-list-declaration'
      - include: '#block'
      - include: '#macro-value'
  
  # Parameter declaration
  parameter-list-declaration:
    begin: '\('
    end: '\)'
    endCaptures:
      0:
        name: punctuation.parenthesis.close
    patterns:
      - include: '#parameter-declaration'
    
  parameter-declaration:
    match: '(ref\s+)?{{type}}\s*{{part}}'
    captures:
      1:
        name: storage.modifier
      2:
        patterns:
          - include: '#type-matcher'
      7:
        name: variable.parameter
  
  macro-value:
    begin: ':'
    end: ';'
    beginCaptures:
      0:
        name: punctuation.separator
    endCaptures:
      0:
        name: '{{statement-end}}'
    patterns:
      - include: '#expression'

  # Rules
  rule:
    begin: '(rule)\s*(:)\s*({{string-double}})' # rule: "string"
    end: '{{encapsulated-block-end}}'
    beginCaptures:
      1:
        name: keyword.control
      2:
        name: punctuation.separator.colon
      3:
        name: string.quoted.double

    patterns:
    # Event attribute
    - match: (Event|Team|Player)\s*(\.)\s*{{part}}
      captures:
        1:
          name: support.type
        2:
          name: punctuation.accessor
        3:
          name: support.variable
    
    # Rule condition
    - begin: '(if)\s*(\()'
      end: '\)'
      beginCaptures:
        1:
          name: keyword.control.conditional.if
        2:
          name: punctuation.parenthesis.open
      endCaptures:
        0:
          name: punctuation.parenthesis.close
      patterns:
        - include: '#expression'
    - include: '#block'

  # Block that contains statements.
  block:
    begin: '{'
    end: '}'
    beginCaptures:
      0:
        name: punctuation.curlybrace.open
    endCaptures:
      0:
        name: punctuation.curlybrace.close
    patterns:
      - include: '#statement'
  
  # Statement
  statement:
    patterns:
      # Return statement
      - begin: return
        end: ;
        beginCaptures:
          0:
            name: keyword.control.flow.return
        endCaptures:
          0:
            name: '{{statement-end}}'
        patterns:
          - include: '#expression'
      - include: '#function-call'
  
  # Expressions
  expression:
    patterns:
      - include: '#number'
      - include: '#boolean'
      - include: '#string'
      - include: '#function-call'
  
  # Numbers
  number:
    patterns:
      - match: \b-?[0-9]+(\.[0-9]+)?\b
        name: constant.numeric
  
  # Booleans
  boolean:
    match: (true)|(false)
    captures:
      1:
        name: constant.language.boolean.true
      2:
        name: constant.language.boolean.false
  
  # Strings
  string:
    patterns:
    - match: '{{string-single}}'
      name: string.quoted.single
    - match: '{{string-double}}'
      name: string.quoted.double
  
  # Function call
  function-call:
    begin: (.?)\s*{{part}}\s*(\()
    end: \)
    beginCaptures:
      1:
        name: punctuation.accessor
      2:
        name: entity.name.function
      3:
        name: punctuation.parenthesis.open
    endCaptures:
      0:
        name: punctuation.parenthesis.close
    patterns:
      - include: '#argument-list'

  # Argument list
  argument-list:
    patterns:
      - include: '#expression'
      # Named argument
      - begin: '{{part}}\s*(:)'
        end: '\s*(?=,|\))'
        beginCaptures:
          1:
            name: variable.parameter
          2:
            name: punctuation.separator.colon
        patterns:
          - include: '#expression'
      # Parameter comma seperator
      - match: ','
        name: punctuation.separator.comma